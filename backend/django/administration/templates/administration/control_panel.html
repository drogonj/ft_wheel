{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ft_wheel - Control Panel</title>
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <link rel="stylesheet" href="{% static 'css/admin_base.css' %}">
    <link rel="stylesheet" href="{% static 'css/control_panel.css' %}">
    <!-- wheel.png Designed by Freepik -->
    <link rel="icon" type="image/png" href="{% static 'images/wheel.png' %}">
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="navbar-left">
                <a href="/" class="navbar-brand">
                    <!-- wheel.png Designed by Freepik -->
                    <img src="{% static 'images/wheel.png' %}" alt="wheel.png Designed by Freepik" class="navbar-logo">
                    <span>ft_wheel - Control Panel</span>
                </a>
            </div>
            <div class="navbar-right">
                <div class="user-info">
                    <span class="user-name">{{ request.user.login }}</span>
                    <span class="user-role">({{ request.user.get_role_display }})</span>
                </div>
                <a href="/" class="btn btn-secondary">Home</a>
                <a href="/adm/django-admin" class="btn btn-secondary">Django</a>
                <a href="/adm/history" class="btn btn-secondary">History</a>
                <a href="/adm/wheels" class="btn btn-secondary">Wheels</a>
                <a href="/logout" class="btn btn-secondary">Logout</a>
            </div>
        </div>
    </div>

    <div class="admin-container">
        <div class="admin-header">
            <h1>Control Panel</h1>
            <p>Manage site-wide settings and monitor system status</p>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                    <div class="stat-value">{{ stats.total_users }}</div>
                    <div class="stat-label">Total Users</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üü¢</div>
                <div class="stat-content">
                    <div class="stat-value">{{ stats.active_users_today }}</div>
                    <div class="stat-label">Active Today</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-content">
                    <div class="stat-value">{{ stats.total_spins_today }}</div>
                    <div class="stat-label">Spins Today</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-content">
                    <div class="stat-value">{{ stats.error_spins_today }}</div>
                    <div class="stat-label">Errors Today</div>
                </div>
            </div>
        </div>

        <!-- Main Settings -->
        <div class="settings-grid">
            <!-- Maintenance Mode -->
            <div class="settings-card">
                <div class="settings-header">
                    <h2>üîß Maintenance Mode</h2>
                    <div class="status-indicator {% if settings.maintenance_mode %}status-enabled{% else %}status-disabled{% endif %}">
                        {% if settings.maintenance_mode %}ENABLED{% else %}DISABLED{% endif %}
                    </div>
                </div>
                <div class="settings-content">
                    <p>When enabled, all users except admins will see a maintenance page.</p>
                    {% if user_role == 'admin' %}
                    <div class="form-group">
                        <label for="maintenance-message">Maintenance Message:</label>
                        <textarea id="maintenance-message" rows="3" placeholder="Enter maintenance message...">{{ settings.maintenance_message }}</textarea>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="toggleMaintenance(true)">Enable Maintenance</button>
                        <button class="btn btn-secondary" onclick="toggleMaintenance(false)">Disable Maintenance</button>
                    </div>
                    {% else %}
                    <p class="permission-notice">You need admin permissions to modify this setting.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Announcement Message -->
            <div class="settings-card">
                <div class="settings-header">
                    <h2>üì£ Announcement</h2>
                </div>
                <div class="settings-content">
                    <p>This message appears as a marquee on the homepage.</p>
                    {% if user_role == 'admin' %}
                    <div class="form-group">
                        <label for="announcement-message">Announcement Message:</label>
                        <input id="announcement-message" type="text" maxlength="255" value="{{ settings.announcement_message }}" placeholder="Welcome on ft_wheel, have fun !" />
                        <small>Max 255 characters</small>
                    </div>
                    <button class="btn btn-primary" onclick="updateAnnouncement()">Update Announcement</button>
                    {% else %}
                    <p class="permission-notice">You need admin permissions to modify this setting.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Jackpot Settings -->
            <div class="settings-card">
                <div class="settings-header">
                    <h2>üí∞ Jackpot Cooldown</h2>
                    <div class="current-value">{{ stats.jackpot_cooldown_hours }}h</div>
                </div>
                <div class="settings-content">
                    <p>Time users must wait between jackpot attempts.</p>
                    {% if user_role == 'admin' %}
                    <div class="form-group">
                        <label for="cooldown-hours">Cooldown (hours):</label>
                        <input type="number" id="cooldown-hours" min="1" max="168" value="{{ stats.jackpot_cooldown_hours }}">
                        <small>Between 1 hour and 1 week (168 hours)</small>
                    </div>
                    <button class="btn btn-primary" onclick="updateJackpotCooldown()">Update Cooldown</button>
                    {% else %}
                    <p class="permission-notice">You need admin permissions to modify this setting.</p>
                    {% endif %}
                </div>
            </div>

            <!-- System Status -->
            <div class="settings-card">
                <div class="settings-header">
                    <h2>üìä System Status</h2>
                    <div class="status-indicator status-enabled">ONLINE</div>
                </div>
                <div class="settings-content">
                    <div class="system-stats">
                        <div class="system-stat">
                            <span class="stat-label">Active Users (Week):</span>
                            <span class="stat-value">{{ stats.active_users_week }}</span>
                        </div>
                        <div class="system-stat">
                            <span class="stat-label">Total Spins (Week):</span>
                            <span class="stat-value">{{ stats.total_spins_week }}</span>
                        </div>
                        <div class="system-stat">
                            <span class="stat-label">Last Updated:</span>
                            <span class="stat-value" id="last-updated">Just now</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="refreshStats()">Refresh Stats</button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="settings-card">
                <div class="settings-header">
                    <h2>‚ö° Quick Actions</h2>
                </div>
                <div class="settings-content">
                    <div class="quick-actions">
                        <a href="/adm/history" class="btn btn-outline">View History</a>
                        <a href="/adm/wheels" class="btn btn-outline">Manage Wheels</a>
                        <button class="btn btn-outline" onclick="exportLogs()">Export Logs</button>
                        <button class="btn btn-outline" onclick="clearCache()">Clear Cache</button>
                    </div>
                </div>
            </div>

            <!-- Tickets Management -->
            <div class="settings-card">
                <div class="settings-header">
                    <h2>üé´ Tickets</h2>
                </div>
                <div class="settings-content">
                    <p>Grant spin tickets to users for specific wheels. Tickets are required for wheels marked as ticket-only.</p>
                    {% if user_role == 'admin' or user_role == 'moderator' %}
                    <div class="form-group">
                        <label for="ticket-login">User login:</label>
                        <input type="text" id="ticket-login" placeholder="marvin" />
                    </div>
                    <div class="form-group">
                        <label for="ticket-wheel">Wheel slug:</label>
                        <input type="text" id="ticket-wheel" placeholder="standard" />
                        <small>Use one of the slugs from Wheels admin page</small>
                    </div>
                    <button class="btn btn-primary" onclick="grantTicket()">Grant Ticket</button>
                    {% else %}
                    <p class="permission-notice">You need admin permissions to grant tickets.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Tickets Summary (separate, scrollable) -->
            <div class="settings-card">
                <div class="settings-header" style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                    <h2 style="margin:0">üìÑ Tickets Summary</h2>
                    <div class="header-actions">
                        <button class="btn" onclick="refreshTickets()">Refresh Summary</button>
                    </div>
                </div>
                <div class="settings-content">
                    <div id="tickets-summary" style="max-height: 300px; overflow-y: auto; margin-top: .25rem; font-size: 0.95rem; border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: .75rem; background: rgba(255,255,255,0.03)"></div>
                </div>
            </div>

        <!-- Recent Activity -->
        {% if recent_users or recent_errors %}
        <div class="activity-section">
            <h2>Recent Activity</h2>
            <div class="activity-grid">
                {% if recent_users %}
                <div class="activity-card">
                    <h3>üë• Recent Users</h3>
                    <div class="activity-list">
                        {% for user in recent_users %}
                        <div class="activity-item">
                            <div class="activity-avatar">{{ user.first_name.0 }}{{ user.last_name.0 }}</div>
                            <div class="activity-content">
                                <div class="activity-name">{{ user.first_name }} {{ user.last_name }}</div>
                                <div class="activity-time">{{ user.last_login|timesince }} ago</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if recent_errors %}
                <div class="activity-card">
                    <h3>‚ö†Ô∏è Recent Errors</h3>
                    <div class="activity-list">
                        {% for error in recent_errors %}
                        <div class="activity-item error-item">
                            <div class="activity-content">
                                <div class="activity-name">{{ error.user.first_name }} {{ error.user.last_name }}</div>
                                <div class="activity-time">{{ error.timestamp|timesince }} ago</div>
                                <div class="activity-details">Failed spin attempt</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing...</div>
    </div>

    <script src="{% static 'js/control_panel.js' %}"></script>
</body>
</html>